<script lang="ts">
    import { onMount } from "svelte";
    import { io, type Socket } from "socket.io-client";
    import type { MatchupEntry } from "../../../static/data/MatchupEntry";
    import WaitingForGame from "./WaitingForGame.svelte";
    import Bars from "./Bars.svelte";
    import type { MoveBar } from "./types";
    import type { TrimmedSettings, PlayerWithShortName } from "./types";
    import { settings } from "$lib/state/settings.svelte";
    import {
        SAMPLE_DYNAMIC_DATA,
        koPercentReached,
        calculateProgress,
    } from "./koUtils";
    import { initGameState, extractOpponentPercent } from "./gameHandlers";
    import { printSettings } from "$lib/state/settings.svelte";
    import { trackEvent } from "@aptabase/tauri";
    import DevTestSuite from "./DevTestSuite.svelte";
    import Status from "./Status.svelte";

    // TODO: Remove after dev
    $effect(function printGlobalSettings() {
        printSettings();
    });

    interface PlayerStats {
        character?: string;
        percent?: number;
    }

    interface GameState {
        matchupData: MatchupEntry | undefined;
        currentPercent: number | undefined;
        displayStageName: string | undefined;
        myChar: string;
        opponentChar: string;
        opponentPlayerIdx: number;
        myConnectCode: string;
        opponentConnectCode: string;
    }

    let gameState: GameState = $state({
        matchupData: undefined,
        currentPercent: undefined,
        displayStageName: undefined,
        myChar: "",
        opponentChar: "",
        opponentPlayerIdx: 1,
        myConnectCode: settings.connectCode,
        opponentConnectCode: "",
    });

    const socket: Socket = io(
        "http://localhost:8090",
        // TODO: These settings are purely for keeping a cleaner console in dev
       {
            autoConnect: false,
            transports: ["websocket"],
        },
    );

    async function onGameStart(settings: TrimmedSettings) {
        // TODO: Include analytics here
        console.log("testing trackevent");
        trackEvent("game_start");
        const newGameState = await initGameState(
            settings,
            gameState.myConnectCode,
        );
        gameState = {
            ...gameState,
            matchupData: newGameState.matchupData,
            myChar: newGameState.myChar,
            opponentChar: newGameState.opponentChar,
            opponentPlayerIdx: newGameState.opponentPlayerIdx,
            displayStageName: newGameState.displayStageName,
        };
        // console.log("gameState", gameState)
    }

    function onSlippiUpdate(players: PlayerStats[]) {
        const newPercent = extractOpponentPercent(
            players,
            gameState.opponentPlayerIdx,
        );
        gameState = {
            ...gameState,
            currentPercent: newPercent,
        };
    }

    function onGameEnd() {
        // TODO: Currently useful to be undefined for dev environment 
        gameState = {
            ...gameState,
            // matchupData: undefined,
            // currentPercent: undefined,
            // displayStageName: undefined,
        };
    }

    onMount(() => {
        socket.on("game_start", onGameStart);
        socket.on("slippi_update", onSlippiUpdate);
        socket.on("game_end", onGameEnd);
        socket.on("connect", () => {
            console.log("Connected to sidecar Socket.IO server");
        });
        socket.on("connect_error", (error) => {
            console.debug("Socket connection failed:", error.message);
        });
        socket.connect();

        return () => socket.disconnect();
    });

    const movesSource = $derived.by(function determineSource() {
        return gameState.matchupData?.moves ?? SAMPLE_DYNAMIC_DATA.moves;
    });

    let limit: number = $state(0);
    let dynamicBars: MoveBar[] = $derived.by(() => {
        console.debug("movesSource", movesSource);
        const allBars = Object.entries(movesSource).map(
            function prepareBarData([moveName, koPercent]) {
                //console.log("moveName", moveName)
                //console.log("koPercent", koPercent)
                return {
                    moveName,
                    koPercent,
                    width: calculateProgress(
                        gameState.currentPercent || 0,
                        koPercent,
                    ),
                    highlight: koPercentReached(
                        gameState.currentPercent || 0,
                        koPercent,
                    ),
                };
            },
        );
        return allBars.slice(0, allBars.length - limit);
    });

    // TODO: Remove after dev
    $effect(function printBars() {
        console.log("dynamicBars", dynamicBars);
    });
</script>

<div class="flex flex-col gap-y-2">
    <DevTestSuite bind:currentPercent={gameState.currentPercent} bind:limit />
    <Status {gameState} />
    {#if false}<WaitingForGame />{/if}
    <Bars {dynamicBars} />
</div>

<style></style>
